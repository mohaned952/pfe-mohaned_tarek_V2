generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  TEACHER
}

enum SubmissionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model User {
  id          Int       @id @default(autoincrement())
  githubId    String    @unique @map("github_id")
  username    String
  email       String?   @unique
  role        UserRole  @default(STUDENT)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  submissions Submission[] @relation("StudentSubmissions")
  reviews     Submission[] @relation("TeacherReviews")
  suites      TestSuite[]
  feedbacks   Feedback[] @relation("FeedbackAuthor")

  @@index([role])
  @@map("users")
}

model Submission {
  id           Int              @id @default(autoincrement())
  studentId    Int              @map("student_id")
  evaluatorId  Int?             @map("evaluator_id")
  repoUrl      String           @map("repo_url")
  repoBranch   String           @default("main") @map("repo_branch")
  language     String
  commitSha    String?          @map("commit_sha")
  status       SubmissionStatus @default(PENDING)
  grade        Float?           
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  student      User             @relation("StudentSubmissions", fields: [studentId], references: [id])
  evaluator    User?            @relation("TeacherReviews", fields: [evaluatorId], references: [id])
  results      TestResult[]
  feedback     Feedback?

  @@index([studentId])
  @@index([evaluatorId])
  @@index([status])
  @@map("submissions")
}

model TestSuite {
  id             Int      @id @default(autoincrement())
  ownerId        Int      @map("owner_id")
  title          String
  language       String
  groupName      String?  @map("group_name")
  year           String?
  definitionJson String   @map("definition_json")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  owner          User     @relation(fields: [ownerId], references: [id])

  @@index([ownerId])
  @@index([language])
  @@map("test_suites")
}

model TestResult {
  id           Int      @id @default(autoincrement())
  submissionId Int      @map("submission_id")
  name         String
  passed       Boolean
  score        Float    @default(0)
  maxScore     Float    @default(1) @map("max_score")
  runtimeMs    Int      @default(0) @map("runtime_ms")
  output       String?
  error        String?
  createdAt    DateTime @default(now()) @map("created_at")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("test_results")
}

model Feedback {
  id               Int      @id @default(autoincrement())
  submissionId     Int      @unique @map("submission_id")
  authorId         Int?     @map("author_id")
  summary          String
  strengthsJson    String   @default("[]") @map("strengths_json")
  improvementsJson String   @default("[]") @map("improvements_json")
  createdAt        DateTime @default(now()) @map("created_at")
  submission       Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  author           User?      @relation("FeedbackAuthor", fields: [authorId], references: [id])

  @@index([authorId])
  @@map("feedback")
}
